<!DOCTYPE html>
<html>
<head>
  <title>Lede</title>
  <link href='http://fonts.googleapis.com/css?family=Istok+Web' rel='stylesheet' type='text/css'>
  <link href='/stylesheets/admin.css' media='all' rel='stylesheet' type='text/css'>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/js-signals/0.8.1/js-signals.min.js"></script>
  <script src="/javascripts/hasher.min.js"></script>
  <script src="/javascripts/api.js"></script> 
  <script type='text/javascript'>

    var activeUser = {};
    var adminUser = {};

    // grab the list of users from the backend
    function initPage() {
      $('#user-details').hide();
      api.user.list(function(users) {
        _.each(users, function(user) {
          $('.user-list ul').append(
            '<li>'+
              '<a href="#user/'+user.id+'">'+
                user.email+
              '</a>'+
            '</li>'
          );
        });
      });
    }

    // grab the list of ledes from the backend
    function updateRecommendations(userid, callback) {
      api.recommendation.list({user_id: userid, sent: false}, function(recommendations) {
        var li = recommendations.length ? '' : '<li>Queue up some ledes!</li>'; 
        $('.add-lede ul').html(li);

        _.each(recommendations, function(recommendation) {
          $('.add-lede ul').append(
            '<li>'+
              '<a href="' + recommendation.uri + '" target="_blank">'+
                recommendation.title+
              '</a>'+
            '</li>'
          );
        });
      });
      callback();
    }

    // grab the list of bookmarklet hits from the backend
    function updateLedes(userid, callback) {
      api.lede.list(userid, function(ledes) {
        var li = ledes.length ? '' : '<li>No bookmarklet hits yet. Check back soon!</li>';
        $('.recent-bookmarklets ul').html(li);

        _.each(ledes, function(lede) {
          $('.recent-bookmarklets ul').append(
            '<li>'+
              '<a href="'+lede.uri+'" target="_blank">'+
                lede.uri+
              '</a>'+
            '</li>'
          );
        });
      });
      callback();
    }


    // render up the user details 
    function renderUserDetails(userid) {
      var callbackCount = 2;
      $('#user-details').fadeOut(300);

      updateLedes(userid, function(){
        callbackCount--;
        if(callbackCount === 0) {
          $('#user-details').fadeIn(200);
        }
      });

      updateRecommendations(userid, function(){
        callbackCount--;
        if(callbackCount === 0) {
          $('#user-details').fadeIn(200);
        }
      });

    }

    $(function() {

      //naive route handling
      var userid;
      function router(newHash, oldHash) {
        if(newHash.match(/user\/[0-9]+/)) {
          userid = newHash.split('/')[1];
          api.user.find(userid, function(user) {
            activeUser = user;
            renderUserDetails(user.id);
          });
        }
      }

      hasher.changed.add(router);
      hasher.initialized.add(router);
      hasher.init();

      api.user.check(function(user) {
        adminUser = user.result;
      }, 
      function() {
        window.location='/login.html';
      });

      initPage();

      // Handler to add ledes
      $('#add-lede-form').submit(function(evt) {
        evt.preventDefault();

        var recommendation = { 
          user_id: userid,
          created_by_user_id: adminUser.id,
          uri: $('input[name=lede-url]').val(),
          title: $('input[name=lede-title]').val(),
          author: $('input[name=lede-author]').val(),
          description: $('input[name=lede-description]').val(),
          image_url: $('input[name=lede-image-url]').val(),
          sent: false
        };

        api.recommendation.create(recommendation, function() {
          updateRecommendations(userid, function() {
            $('input[name=lede-url]').val('');
            $('input[name=lede-title]').val('');
            $('input[name=lede-author]').val('');
            $('input[name=lede-description]').val('');
            $('input[name=lede-image-url]').val('');
          });
        });
      });

      // Handler to look up lede data
      $('#lookup-lede').click(function(evt) {
        evt.preventDefault();
        $('#notification').html(
          '<p>Extracting Lede Details...</p>'+
          '<img src="/images/ajax-loader.gif">'
        );
        $('#notification').fadeIn(200);
        api.extractor.extract({url: $('input[name=lede-url]').val()}, function(recommendation) {
          $('input[name=lede-title]').val(recommendation.title);
          $('input[name=lede-description]').val(recommendation.description);
          $('input[name=lede-image-url]').val(recommendation.image);
          $('#lede-image-preview').html('<img src="'+recommendation.image+'" width="75" height="75">');
          $('#notification').fadeOut(500);
          $('#notification').html('');
        });
      });

      // Handler to send daily email
      $('#send-email').click(function(evt) {
        evt.preventDefault();
        $('#notification').html(
          '<p>Sending Email...</p>'+
          '<img src="/images/ajax-loader.gif">'
        );
        $('#notification').fadeIn(200);
        api.notifier.sendDaily(activeUser, function(r) {
          updateRecommendations(userid, function() {
            $('#notification').fadeOut(500);
            $('#notification').html('');
          });
        });
      });

    });

  </script>
</head>
<body>
 <div id="admin-header" class="admin-header">
   <img class="header" src="/images/control_panel_alt.png" width="64" height="64">
   <h1>Lede Panel</h1>
 </div>
  <div id="user-admin" class="user-admin">
    <div id="user-list" class="user-list">
      <h2>Users</h2>
      <input type="text" name="user-search" placeholder="Search">
      <ul>
      </ul>
    </div>
    <div id="user-details" class="user-details">

      <div id="recent-bookmarklets" class="recent-bookmarklets">
        <h2>Recent Bookmarklets</h2>
        <ul>
        </ul>
      </div>
      <div id="add-lede" class="add-lede">
        <h2>Add Lede</h2>
        <form id="add-lede-form">
          <input type="text" name="lede-url" placeholder="URL">
          <input type="text" name="lede-title" placeholder="Title">
          <input type="text" name="lede-author" placeholder="Author">
          <input type="text" name="lede-description" placeholder="Description">
          <input type="text" name="lede-image-url" placeholder="Image URL">
          <button id="lookup-lede">Lookup Lede</button>
          <button type="submit">Add Lede</button>
        </form>

        <h2>Queued Ledes</h2>
        <ul>
        </ul>
      </div>
      <div id="last-email-sent" class="last-email-sent">
        Last email sent : %s by %s
        <form id="send-email-form">
          <button id="send-email">Send Email</button>
        </form>
        <div id="lede-image-preview" class="lede-image-preview">
        </div>
      </div>
    </div>
  </div>
  <div id="admin-dashboard" class="admin-dashboard">
    <div id="notification" class="notification"></div>
  </div>
  
<!-- Don't need GA yet, but keeping here for the near future :)
 <script>
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
-->
</body>
</html>
